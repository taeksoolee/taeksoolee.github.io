<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>ê³ í’ˆì§ˆ ë¬´ë£Œ ìŒì„± ì œì–´ ë¦¬ë”</title>
  <style>
    body {
      font-family: 'Pretendard', sans-serif;
      padding: 20px;
      line-height: 1.8;
      max-width: 800px;
      margin: 0 auto;
      background: #fdfdfd;
    }

    #content {
      padding: 30px;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 15px;
      font-size: 1.2em;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .status-panel {
      background: #4a90e2;
      color: white;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .controls {
      margin-bottom: 30px;
      display: flex;
      gap: 10px;
    }

    button {
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn-mic {
      background: #ff5252;
      color: white;
    }

    .btn-action {
      background: #e0e0e0;
      color: #333;
    }

    .manual-container {
      padding: 25px;
      background: #f1f3f5;
      border-radius: 15px;
    }

    .cmd-tag {
      background: #fff;
      color: #4a90e2;
      padding: 2px 8px;
      border-radius: 4px;
      border: 1px solid #4a90e2;
      font-weight: bold;
      margin-right: 4px;
    }
  </style>
</head>

<body>

  <h2>ğŸ™ï¸ ë¬´ë£Œ ê³ í’ˆì§ˆ ìŒì„± ì œì–´ ë¦¬ë”</h2>

  <div class="status-panel">
    ìƒíƒœ: <span id="status">ë§ˆì´í¬ë¥¼ ì¼œì£¼ì„¸ìš”</span> | ì¸ì‹: <span id="recognized">-</span>
  </div>

  <div id="content">
    1. ì‹ìš©ìœ  2í°ìˆ ë„£ê³  ëŒ€íŒŒ ë§ˆëŠ˜ ìƒê°•ì„ ë„£ê³  ë³¶ì•„ì¤ë‹ˆë‹¤.
  </div>

  <div class="controls">
    <button class="btn-mic" onclick="startListening()">ğŸ¤ ë§ˆì´í¬ ì¼œê¸°</button>
    <button class="btn-action" onclick="handleAction('restart')">ì²˜ìŒë¶€í„°</button>
    <button class="btn-action" onclick="stopSpeaking()">ë©ˆì¶¤</button>
  </div>

  <div class="manual-container">
    <h3>ğŸ“– ì´ìš© ê°€ì´ë“œ (ë¬´ë£Œ ë²„ì „)</h3>
    <table style="width:100%; border-spacing: 0 10px;">
      <tr>
        <td><span class="cmd-tag">"ì²˜ìŒë¶€í„°"</span></td>
        <td>ë§¨ ì•ìœ¼ë¡œ ëŒì•„ê°€ ë‚­ë… ì‹œì‘</td>
      </tr>
      <tr>
        <td><span class="cmd-tag">"ë©ˆì¶°"</span> / <span class="cmd-tag">"ê·¸ë§Œ"</span></td>
        <td>ì½ê¸° ì¼ì‹œ ì •ì§€</td>
      </tr>
      <tr>
        <td><span class="cmd-tag">"ì¬ìƒ"</span> / <span class="cmd-tag">"ë‹¤ì‹œ ì‹œì‘"</span></td>
        <td>ë©ˆì¶˜ ì§€ì ë¶€í„° ë‹¤ì‹œ ì½ê¸°</td>
      </tr>
      <tr>
        <td><span class="cmd-tag">"ì´ì „"</span> / <span class="cmd-tag">"ë’¤ë¡œ"</span></td>
        <td>ì•½ 5ì´ˆ ì „ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°</td>
      </tr>
    </table>
  </div>

  <script>
    const contentDiv = document.getElementById('content');
    const statusText = document.getElementById('status');
    const recognizedText = document.getElementById('recognized');
    const words = contentDiv.innerText.trim().split(/\s+/);

    let currentWordIndex = 0;
    let isCommandProcessing = false;
    let synth = window.speechSynthesis;
    let selectedVoice = null;

    // [ì¤‘ìš”] ë¸Œë¼ìš°ì €ì—ì„œ ì œê³µí•˜ëŠ” ê°€ì¥ ìì—°ìŠ¤ëŸ¬ìš´ ëª©ì†Œë¦¬ ì°¾ê¸°
    function loadVoices() {
      const voices = synth.getVoices();
      // 1ìˆœìœ„: Edge/Chromeì˜ ì‹ ê²½ë§ í•œêµ­ì–´(Natural), 2ìˆœìœ„: êµ¬ê¸€ í•œêµ­ì–´, 3ìˆœìœ„: ê¸°ë³¸ í•œêµ­ì–´
      selectedVoice = voices.find(v => v.name.includes('Natural') && v.lang.includes('ko')) ||
        voices.find(v => v.lang.includes('ko-KR') && v.name.includes('Google')) ||
        voices.find(v => v.lang.includes('ko-KR'));
    }
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = loadVoices;
    }

    // STT ì„¤ì •
    const recognition = new(window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'ko-KR';
    recognition.continuous = false;
    recognition.interimResults = true;

    recognition.onresult = (event) => {
      let transcript = Array.from(event.results).map(res => res[0].transcript).join('');
      recognizedText.innerText = transcript;
      if (isCommandProcessing) return;

      if (transcript.includes("ì²˜ìŒë¶€í„°")) handleAction('restart');
      else if (transcript.includes("ë©ˆì¶°") || transcript.includes("ê·¸ë§Œ")) handleAction('stop');
      else if (transcript.includes("ì¬ìƒ") || transcript.includes("ë‹¤ì‹œ ì‹œì‘")) handleAction('resume');
      else if (transcript.includes("ì´ì „") || transcript.includes("ë’¤ë¡œ")) handleAction('back');
    };

    function handleAction(action) {
      isCommandProcessing = true;
      if (action === 'restart') {
        currentWordIndex = 0;
        speakFrom(0);
      } else if (action === 'stop') {
        stopSpeaking();
      } else if (action === 'resume') {
        speakFrom(currentWordIndex);
      } else if (action === 'back') {
        stopSpeaking();
        currentWordIndex = Math.max(0, currentWordIndex - 10);
        setTimeout(() => speakFrom(currentWordIndex), 300);
      }

      recognition.stop();
      setTimeout(() => {
        isCommandProcessing = false;
      }, 1000);
    }

    recognition.onend = () => recognition.start();

    function startListening() {
      recognition.start();
      statusText.innerText = "ëª…ë ¹ ëŒ€ê¸° ì¤‘...";
      loadVoices();
    }

    function speakFrom(index) {
      synth.cancel();
      const text = words.slice(index).join(' ');
      const utterance = new SpeechSynthesisUtterance(text);

      if (selectedVoice) utterance.voice = selectedVoice; // ê°€ì¥ ì¢‹ì€ ëª©ì†Œë¦¬ ì ìš©
      utterance.lang = 'ko-KR';
      utterance.rate = 0.9; // ë‚­ë…ì— ì í•©í•œ ì†ë„

      utterance.onboundary = (event) => {
        if (event.name === 'word') {
          const spoken = event.utterance.text.substring(0, event.charIndex);
          currentWordIndex = index + spoken.trim().split(/\s+/).length - 1;
        }
      };

      utterance.onstart = () => statusText.innerText = "ìì—°ìŠ¤ëŸ½ê²Œ ì½ëŠ” ì¤‘...";
      synth.speak(utterance);
    }

    function stopSpeaking() {
      synth.cancel();
      statusText.innerText = "ì •ì§€ë¨";
    }
  </script>
</body>

</html>